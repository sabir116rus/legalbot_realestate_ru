
# LegalBot — Юридический Telegram‑бот (Недвижимость, RU)

Проект: чат-бот в Telegram c нейроассистентом OpenAI для консультаций по теме **недвижимости**. 
Подход: **Python (aiogram 3) + простая RAG по CSV**.

## Быстрый старт

1) Создай бота у @BotFather и получи **TELEGRAM_BOT_TOKEN**.  
2) Получи ключ OpenAI и укажи **OPENAI_API_KEY**.  
3) Скопируй `.env.example` в `.env` и заполни значения.  
4) Установи зависимости:  
   ```bash
   pip install -r requirements.txt
   ```
5) Запусти бота:  
   ```bash
   python bot.py
   ```

Команды:
- `/start` — приветствие и запуск
- `/help` — помощь и подсказки по формату вопросов

Вопросы можно задавать в свободной форме: просто отправь текст с описанием ситуации, и бот подберёт ответ из базы знаний.

## Архитектура

```
Telegram (пользователь)
   ↓
Aiogram (бот)
   ↓
OpenAI (GPT)  ←  RAG (CSV: data/knowledge.csv)
   ↓
Форматированный ответ с рекомендациями и ссылками
```

## Структура
```
legalbot_realestate_ru/
├─ bot.py                # основной скрипт бота
├─ rag.py                # загрузка CSV и поиск релевантных статей/ответов
├─ analyze_logs.py       # утилита для аналитики логов
├─ prompt_system_ru.txt  # системные инструкции ассистента
├─ requirements.txt
├─ .env.example
├─ services/
│  ├─ answer_service.py      # бизнес-логика генерации ответов через OpenAI и RAG
│  └─ interaction_logger.py  # запись обращений в CSV с токенами и статусом
└─ data/
   └─ knowledge.csv      # база знаний (CSV)
```

## Основные компоненты

- `Config.load` из `config.py` читает переменные окружения, подставляет значения по умолчанию, проверяет обязательные ключи и подготавливает пути к базе знаний, системному промпту и CSV‑логу.
- `AnswerService` (см. `services/answer_service.py`) объединяет результаты RAG с системным промптом и вызывает `AsyncOpenAI` для получения ответа. В ответ включаются найденные фрагменты, при сетевых ошибках возвращается человеко‑понятное сообщение и статус `error`.
- `InteractionLogger` (см. `services/interaction_logger.py`) создаёт CSV‑лог, добавляет заголовки при первом запуске, сохраняет обрезанные ответы, top_score и количество токенов (через `tiktoken`).

## Утилиты

- `analyze_logs.py` — собирает статистику по CSV логам, строит распределения по темам, моделям и временным интервалам. Пример запуска:
  ```bash
  python analyze_logs.py --log data/log.csv
  ```

## Оценка покрытия

Скрипт `evaluate_csv_coverage.py` помогает определить, какие вопросы в логах остаются без релевантных ответов из базы знаний.

```bash
python evaluate_csv_coverage.py --threshold 60
```

- `--threshold` — минимальное значение `top_score`, при котором вопрос считается покрытым.
- `--recompute-score` — пересчитать оценки через `KnowledgeBase` вместо использования сохранённых `top_score`.
- `--top-n` — сколько самых проблемных вопросов показать в отчёте.
- `--out report.csv` — сохранить таблицу с проблемными вопросами в файл.
- Обе CLI-утилиты завершаются с кодом `1`, если входные данные не найдены или не читаются: `analyze_logs.py` проверяет существование и содержимое лога, а `evaluate_csv_coverage.py` валидирует путь к CSV и корректность параметров.

## CSV — формат базы знаний

| id | topic | question | answer | law_refs | url |
|----|-------|----------|--------|----------|-----|

- **law_refs** — краткие ссылки на статьи/нормы (например: "ГК РФ ст. 209; 454–491; 558").
- **url** — ссылка на первоисточник (Госуслуги, Consultant, Гарант и т. п.).

## Ограничения и дисклеймер

Бот даёт **информационно‑справочные** ответы по открытым источникам и базе знаний. Не является адвокатом.
Для сложных ситуаций рекомендуем очную консультацию юриста.

## Тестирование

Готовые автотесты лежат в каталоге `tests/` и покрывают загрузку конфигурации, работу RAG, генерацию ответов и логи взаимодействий. Запуск выполняется стандартной командой `pytest`.
